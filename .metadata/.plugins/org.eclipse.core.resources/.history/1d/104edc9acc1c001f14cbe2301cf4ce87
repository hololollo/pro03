<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<c:set var="path" value="${pageContext.request.contextPath}" />
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
    	
    </style>
</head>
<body>
<header>
    <jsp:include page="../include/header.jsp" />
</header>
<main>
    <section class="join_contents">
        <div class="join_wrap">
            <form name="joinform" id="joinform" action="${path}/member/joinPro.do" method="post" onsubmit="return joinCheck(this)">
                <table id="table1" class="table">
                	<div class="input id">
                	<tbody>
                    	<h3>아이디</h3>
                    <input type="text" id="id" name="id" class="id" placeholder="아이디" pattern="^[a-z0-9]{5,12}" maxlength="12" required>
                    <input type="button" id="idbtn" class="button" onclick="idCheck()" value="아이디 중복확인">
                    <input type="hidden" name="idck" id="idck" value="no">
                    <c:if test="${empty qid}">
                        <p id="msg" style="padding-left:0.5rem">아직 아이디 중복 체크를 하지 않으셨습니다.</p>
                    </c:if>
                    <c:if test="${not empty qid}">
                        <p id="msg" style="padding-left:0.5rem">아이디 중복 체크 후 수정하였습니다.</p>
                    </c:if>
                </div>
                <div class="input cfpw">
                    <h3>비밀번호</h3>
                    <input type="password" id="pw" name="pw" class="pw" placeholder="비밀번호" required>
                </div>
                <div class="input cfpw">
                    <h3>비밀번호확인</h3>
                    <input type="password" id="usercfpw" name="usercfpw" class="usercfpw" placeholder="비밀번호확인" required>
                </div>
                <div class="input name">
                    <h3>이름</h3>
                    <input type="text" id="name" name="name" class="name" placeholder="이름" required>
                </div>

                <div class="input email">
                    <h3 class="">이메일주소</h3>
                    <input type="text" id="useremail1" name="useremail1" class="useremail1" placeholder="이메일" required>
                    <span>@</span>
                    <input type="text" id="useremail2" name="useremail2" class="useremail2" placeholder="직접입력" required>
                    <select class="emailbox" id="emailbox" name="emailbox">
                        <option value="self">직접 입력</option> 
                        <option value="naver.com">naver.com</option>
                        <option value="google.com">google.com</option>
                        <option value="hanmail.net">daum.net</option>
                        <option value="nate.com">nate.com</option>
                        <option value="kakao.com">kakao.com</option>
                    </select>
                </div>
                <script>
                    var emaliboxList = document.querySelector('#emailbox');
                    var domainInput = document.querySelector('#useremail2');
                    emaliboxList.addEventListener('change', (event) => {
                        if (event.target.value !== "self") {
                            domainInput.value = event.target.value;
                            domainInput.disabled = true;
                        } else {
                            domainInput.value = "";
                            domainInput.disabled = false;
                        }
                    });
                </script>

                <div class="input birth">
                    <h3>생년월일</h3>
                    <input type="date" id="year" name="year" class="year" placeholder="년(4자)" required>
 
                </div>

                <div class="input tel">
                    <h3 class="">전화번호</h3>
                    <input type="text" id="usertel1" name="usertel1" class="usertel1" placeholder="" required >
                    <span>-</span>
                    <input type="text" id="usertel2" name="usertel2" class="usertel" placeholder="" required >
                    <span>-</span>
                    <input type="text" id="usertel3" name="usertel3" class="usertel" placeholder="" required >
                </div>
                <div class="input addr">
                    <h3 class="">자택주소</h3>
                    <input type="text" id="postcode" name="postcode" class="postcode" placeholder="우편번호" readonly required>
                    <input type="button" id="pcodebtn" class="button" onclick="execDaumPostcode()" value="우편번호 찾기">
                    <input type="text" id="roadaddr1" name="roadaddr1" class="roadaddr1" placeholder="도로명주소" readonly required >
                    <input type="text" id="roadaddr2" name="roadaddr2" class="roadaddr2" placeholder="이하 주소입력" required >
                </div>

                <div class="endbtn">
                    <input type="submit" id="cfbtn" class="button1" value="확인" >
                    <input type="button" id="backbtn" class="button2" onclick="history.back();" value="돌아가기" >
                </div>
            </form>
        </div>
    </section>
    </main>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    var addr = '';
                    var extraAddr = '';
                    if (data.userSelectedType === 'R') {
                        addr = data.roadAddress;
                    } else {
                        addr = data.jibunAddress;
                    }
                    if (data.userSelectedType === 'R') {
                        if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                            extraAddr += data.bname;
                        }
                        if (data.buildingName !== '' && data.apartment === 'Y') {
                            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                        }
                        if (extraAddr !== '') {
                            extraAddr = ' (' + extraAddr + ')';
                        }
                    } else {
                        document.getElementById("addr").value = '';
                    }
                    document.getElementById('postcode').value = data.zonecode;
                    document.getElementById("roadaddr1").value = addr + extraAddr;
                   
                }
            }).open();
        }
        function idCheck() {
            var id = $("#id").val();
            var idPattern = /^(?=.*[a-z])(?=.*\d)[a-z\d]{5,12}$/; // 아이디는 5~12자의 영문 소문자, 숫자 조합, 숫자와 영문이 모두 포함되어야 함

            if (id === "") {
                alert("아이디를 입력하지 않으셨습니다.");
                $("#id").focus();
                return;
            }
         	// 예외 케이스: "admin"
            if (id === "admin") {
                // "admin" 아이디는 특별 처리
                $("#idck").val("yes");
                $("#msg").html("<strong style='color:blue'>사용가능한 아이디 입니다.</strong>");
                return;
            }

            if (!idPattern.test(id)) {
                alert("아이디 패턴이 올바르지 않습니다. 아이디는 5~12자의 영문 소문자와 숫자 조합이어야 합니다.");
                $("#msg").html("<strong style='color:red'>올바르지 않습니다.</strong>")
                $("#id").focus();
                return;
            }

            var params = { id: id };
            $.ajax({
                url: "${path}/member/idCheck.do",
                type: "post",
                dataType: "json",
                data: params,
                success: function(result) {
                    var idChk = result.result;
                    if (idChk === false) {
                        $("#idck").val("no");
                        $("#msg").html("<strong style='color:red'>기존에 사용되고 있는 아이디 입니다. 다시 입력하시기 바랍니다.</strong>");
                        $("#id").focus();
                    } else if (idChk === true) {
                        $("#idck").val("yes");
                        $("#msg").html("<strong style='color:blue'>사용가능한 아이디 입니다.</strong>");
                    } else if (idChk === "") {
                        $("#msg").html("<strong>아이디가 확인되지 않았습니다. 다시 시도해주시기 바랍니다.</strong>");
                    } 
                }
            });
        }
        
        

        function joinCheck(form) {
        	var passwordPattern = /^(?=.*[a-z])(?=.*\d)[a-z\d]{4,}$/; // 최소 4자, 소문자, 숫자 포함
            if ($("#idck").val() == "no") {
                alert("아이디 중복 체크를 해주세요.");
                $("#id").focus();
                return false;
            }
            if ($("#pw").val() != $("#usercfpw").val()) {
                alert("비밀번호와 비밀번호 확인이 일치하지 않습니다.");
                $("#usercfpw").focus();
                return false;
            }
            if (!passwordPattern.test($("#pw").val())) {
                alert("비밀번호는 최소 4자 이상이어야 하며, 영문 소문자 및 숫자를 포함해야 합니다.");
                $("#pw").focus();
                return false;
            }
            return true;
        }
    </script>
<footer>
    <jsp:include page="../include/footer.jsp" />
</footer>
</body>
</html>
